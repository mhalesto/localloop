<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalLoop Admin Dashboard - Complete Version</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getAuth,
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import {
            getFirestore,
            collection,
            query,
            where,
            orderBy,
            limit,
            getDocs,
            doc,
            deleteDoc,
            updateDoc,
            onSnapshot,
            Timestamp,
            getDoc,
            setDoc,
            startAfter,
            endBefore,
            limitToLast,
            getCountFromServer,
            writeBatch,
            addDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9ngUn2O-_TYYzPfEQpDcuNvv-aAMUcIY",
            authDomain: "share-your-story-1.firebaseapp.com",
            projectId: "share-your-story-1",
            storageBucket: "share-your-story-1.firebasestorage.app",
            messagingSenderId: "673056432219",
            appId: "1:673056432219:web:8d54e53d9124fb6e441f7e",
            measurementId: "G-75VDYJHL88"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let charts = {};
        let currentFilters = {
            posts: { search: '', category: 'all', dateRange: 7 },
            users: { search: '', plan: 'all' },
            reports: { status: 'all' }
        };
        let currentPage = {
            posts: 1,
            users: 1,
            reports: 1
        };
        const itemsPerPage = 10;
        let lastVisible = {
            posts: null,
            users: null,
            reports: null
        };

        // Make Firebase accessible globally
        window.firebase = {
            app,
            auth,
            db,
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut,
            collection,
            query,
            where,
            orderBy,
            limit,
            getDocs,
            doc,
            deleteDoc,
            updateDoc,
            onSnapshot,
            Timestamp,
            getDoc,
            setDoc,
            startAfter,
            endBefore,
            limitToLast,
            getCountFromServer,
            writeBatch,
            addDoc
        };

        // Check auth state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Check if user is admin
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists() && (userDoc.data().role === 'admin' || userDoc.data().isAdmin)) {
                    showDashboard();
                    await loadDashboardData();
                    setupRealtimeListeners();
                } else {
                    showMessage('You do not have admin privileges', 'error');
                    signOut(auth);
                }
            } else {
                showLogin();
            }
        });

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('currentUserEmail').textContent = currentUser.email;
        }

        function showMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `message message-${type}`;
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                background: ${type === 'error' ? '#f8d7da' : type === 'success' ? '#d4edda' : '#d1ecf1'};
                color: ${type === 'error' ? '#721c24' : type === 'success' ? '#155724' : '#0c5460'};
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            document.body.appendChild(messageEl);
            setTimeout(() => messageEl.remove(), 5000);
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                showLoading('Loading dashboard data...');
                await Promise.all([
                    loadStats(),
                    loadPosts(),
                    loadUsers(),
                    loadReports(),
                    loadAnalytics()
                ]);
                initCharts();
                hideLoading();
            } catch (error) {
                console.error('Error loading dashboard:', error);
                hideLoading();
                showMessage('Error loading dashboard data', 'error');
            }
        }

        function showLoading(message = 'Loading...') {
            const loader = document.getElementById('globalLoader');
            if (loader) {
                loader.style.display = 'flex';
                loader.querySelector('.loader-text').textContent = message;
            }
        }

        function hideLoading() {
            const loader = document.getElementById('globalLoader');
            if (loader) {
                loader.style.display = 'none';
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                // Get total users
                try {
                    const usersSnapshot = await getCountFromServer(collection(db, 'users'));
                    document.getElementById('totalUsers').textContent = usersSnapshot.data().count.toLocaleString();
                } catch (error) {
                    console.warn('Error loading user count:', error);
                    document.getElementById('totalUsers').textContent = '0';
                }

                // Get active posts (last 7 days)
                try {
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const postsQuery = query(
                        collection(db, 'posts'),
                        where('createdAt', '>=', Timestamp.fromDate(sevenDaysAgo))
                    );
                    const postsSnapshot = await getCountFromServer(postsQuery);
                    document.getElementById('activePosts').textContent = postsSnapshot.data().count.toLocaleString();
                } catch (error) {
                    console.warn('Error loading active posts:', error);
                    // Fallback to simple count
                    try {
                        const postsSnapshot = await getCountFromServer(collection(db, 'posts'));
                        document.getElementById('activePosts').textContent = postsSnapshot.data().count.toLocaleString();
                    } catch (fallbackError) {
                        document.getElementById('activePosts').textContent = '0';
                    }
                }

                // Get today's reports - handle permission errors
                try {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const reportsQuery = query(
                        collection(db, 'reports'),
                        where('createdAt', '>=', Timestamp.fromDate(today))
                    );
                    const reportsSnapshot = await getCountFromServer(reportsQuery);
                    document.getElementById('reportsToday').textContent = reportsSnapshot.data().count;
                } catch (error) {
                    if (error.code === 'permission-denied') {
                        console.warn('Reports access denied - admin permissions may be required');
                        document.getElementById('reportsToday').textContent = '0';
                    } else {
                        console.warn('Error loading reports:', error);
                        document.getElementById('reportsToday').textContent = '0';
                    }
                }

                // Calculate monthly revenue - using consistent pricing
                try {
                    const usersSnapshot2 = await getDocs(collection(db, 'users'));
                    let revenue = 0;
                    usersSnapshot2.forEach(doc => {
                        const user = doc.data();
                        // Use consistent pricing: Premium R99, Gold R199
                        if (user.subscriptionPlan === 'premium') revenue += 99;
                        if (user.subscriptionPlan === 'gold') revenue += 199;
                    });
                    document.getElementById('monthlyRevenue').textContent = `R${revenue.toLocaleString()}`;
                } catch (error) {
                    console.warn('Error calculating revenue:', error);
                    document.getElementById('monthlyRevenue').textContent = 'R0';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                // Don't show error message to avoid spam, just log it
            }
        }

        // Load posts with pagination and filtering
        async function loadPosts(page = 1) {
            try {
                const tbody = document.getElementById('postsTableBody');
                tbody.innerHTML = '<tr><td colspan="9" class="loading-cell">Loading posts...</td></tr>';

                let postsQuery = collection(db, 'posts');
                let constraints = [orderBy('createdAt', 'desc'), limit(itemsPerPage)];

                // Apply filters
                if (currentFilters.posts.category && currentFilters.posts.category !== 'all') {
                    constraints.unshift(where('category', '==', currentFilters.posts.category));
                }

                if (currentFilters.posts.dateRange) {
                    const daysAgo = new Date();
                    daysAgo.setDate(daysAgo.getDate() - currentFilters.posts.dateRange);
                    constraints.unshift(where('createdAt', '>=', Timestamp.fromDate(daysAgo)));
                }

                // Apply pagination
                if (page > 1 && lastVisible.posts) {
                    constraints.push(startAfter(lastVisible.posts));
                }

                const q = query(postsQuery, ...constraints);
                const snapshot = await getDocs(q);

                if (snapshot.docs.length > 0) {
                    lastVisible.posts = snapshot.docs[snapshot.docs.length - 1];
                }

                tbody.innerHTML = '';

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="9" class="empty-cell">No posts found</td></tr>';
                    return;
                }

                for (const postDoc of snapshot.docs) {
                    const post = postDoc.data();
                    const postId = postDoc.id;

                    // Get report count
                    const reportsQuery = query(
                        collection(db, 'reports'),
                        where('postId', '==', postId)
                    );
                    const reportsSnapshot = await getCountFromServer(reportsQuery);
                    const reportCount = reportsSnapshot.data().count;

                    const row = createPostRow(postId, post, reportCount);
                    tbody.appendChild(row);
                }

                // Search functionality
                if (currentFilters.posts.search) {
                    filterTableRows('postsTableBody', currentFilters.posts.search);
                }

                currentPage.posts = page;
                updatePaginationControls('posts', snapshot.docs.length === itemsPerPage);
            } catch (error) {
                console.error('Error loading posts:', error);
                showMessage('Error loading posts', 'error');
            }
        }

        function createPostRow(postId, post, reportCount) {
            const row = document.createElement('tr');
            const date = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'N/A';
            const status = post.status || (reportCount >= 5 ? 'Flagged' : 'Active');
            const statusClass = status === 'Active' ? 'badge-success' :
                               status === 'Flagged' ? 'badge-warning' :
                               status === 'Removed' ? 'badge-danger' : 'badge-info';

            row.innerHTML = `
                <td><input type="checkbox" class="row-checkbox" data-id="${postId}"></td>
                <td class="post-id">${postId.substring(0, 8)}...</td>
                <td class="post-title">${post.title || post.content?.substring(0, 50) || 'No content'}</td>
                <td class="post-author">${post.userName || 'Unknown'}</td>
                <td class="post-category">${post.category || 'General'}</td>
                <td class="post-date">${date}</td>
                <td class="post-reports">
                    ${reportCount > 0 ?
                        `<span class="badge ${reportCount >= 5 ? 'badge-danger' : 'badge-warning'}">${reportCount}</span>` :
                        '0'}
                </td>
                <td class="post-status"><span class="badge ${statusClass}">${status}</span></td>
                <td class="post-actions">
                    <button class="action-btn btn-view" onclick="viewPost('${postId}')">View</button>
                    ${status !== 'Removed' ?
                        `<button class="action-btn btn-delete" onclick="removePost('${postId}')">Remove</button>` :
                        `<button class="action-btn btn-restore" onclick="restorePost('${postId}')">Restore</button>`
                    }
                </td>
            `;
            return row;
        }

        // Load users with pagination and filtering
        async function loadUsers(page = 1) {
            try {
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '<div class="loading-cell">Loading users...</div>';

                let usersQuery = collection(db, 'users');
                let constraints = [orderBy('createdAt', 'desc'), limit(itemsPerPage)];

                // Apply filters
                if (currentFilters.users.plan && currentFilters.users.plan !== 'all') {
                    constraints.unshift(where('subscriptionPlan', '==', currentFilters.users.plan));
                }

                // Apply pagination
                if (page > 1 && lastVisible.users) {
                    constraints.push(startAfter(lastVisible.users));
                }

                const q = query(usersQuery, ...constraints);
                const snapshot = await getDocs(q);

                if (snapshot.docs.length > 0) {
                    lastVisible.users = snapshot.docs[snapshot.docs.length - 1];
                }

                usersList.innerHTML = '';

                if (snapshot.empty) {
                    usersList.innerHTML = '<div class="empty-cell">No users found</div>';
                    return;
                }

                for (const userDoc of snapshot.docs) {
                    const user = userDoc.data();
                    const userId = userDoc.id;

                    // Get post count
                    const postsQuery = query(
                        collection(db, 'posts'),
                        where('userId', '==', userId)
                    );
                    const postsSnapshot = await getCountFromServer(postsQuery);
                    const postCount = postsSnapshot.data().count;

                    const userCard = createUserCard(userId, user, postCount);
                    usersList.appendChild(userCard);
                }

                // Search functionality
                if (currentFilters.users.search) {
                    filterUserCards(currentFilters.users.search);
                }

                currentPage.users = page;
                updatePaginationControls('users', snapshot.docs.length === itemsPerPage);
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('Error loading users', 'error');
            }
        }

        function createUserCard(userId, user, postCount) {
            const plan = user.subscriptionPlan || 'basic';
            const planDisplay = plan.charAt(0).toUpperCase() + plan.slice(1);
            const joinDate = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'N/A';
            const status = user.status || 'active';

            const userCard = document.createElement('div');
            userCard.className = 'user-card';
            userCard.innerHTML = `
                <div class="user-info">
                    <input type="checkbox" class="user-checkbox" data-id="${userId}">
                    <div class="user-avatar" style="background: ${getAvatarColor(user.name || user.email)}">
                        ${user.name ? user.name.charAt(0).toUpperCase() : 'U'}
                    </div>
                    <div class="user-details">
                        <h3>${user.name || 'Unknown User'}</h3>
                        <p>${user.email || 'No email'} • ${planDisplay} Plan • ${postCount} posts • Joined ${joinDate}</p>
                        <span class="badge ${status === 'suspended' ? 'badge-danger' : 'badge-success'}">${status}</span>
                    </div>
                </div>
                <div>
                    <button class="action-btn btn-view" onclick="viewUser('${userId}')">View</button>
                    ${status !== 'suspended' ?
                        `<button class="action-btn btn-delete" onclick="suspendUser('${userId}')">Suspend</button>` :
                        `<button class="action-btn btn-restore" onclick="activateUser('${userId}')">Activate</button>`
                    }
                </div>
            `;
            return userCard;
        }

        function getAvatarColor(name) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#48C9B0', '#5DADE2', '#F7DC6F'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        // Load reports
        async function loadReports() {
            const tbody = document.getElementById('reportsTableBody');
            try {
                tbody.innerHTML = '<tr><td colspan="8" class="loading-cell">Loading reports...</td></tr>';

                const reportsQuery = query(
                    collection(db, 'reports'),
                    orderBy('createdAt', 'desc'),
                    limit(50)
                );
                const snapshot = await getDocs(reportsQuery);

                tbody.innerHTML = '';

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-cell">No reports found</td></tr>';
                    return;
                }

                // Group reports by post
                const reportsByPost = {};
                snapshot.forEach(doc => {
                    const report = doc.data();
                    const reportId = doc.id;
                    if (!reportsByPost[report.postId]) {
                        reportsByPost[report.postId] = {
                            reportIds: [],
                            count: 0,
                            reasons: new Set(),
                            firstReported: report.createdAt,
                            postTitle: report.postTitle || 'Unknown',
                            status: report.status || 'pending'
                        };
                    }
                    reportsByPost[report.postId].reportIds.push(reportId);
                    reportsByPost[report.postId].count++;
                    if (report.reason) {
                        reportsByPost[report.postId].reasons.add(report.reason);
                    }
                    if (report.createdAt < reportsByPost[report.postId].firstReported) {
                        reportsByPost[report.postId].firstReported = report.createdAt;
                    }
                });

                // Display grouped reports
                for (const [postId, reportData] of Object.entries(reportsByPost)) {
                    const row = createReportRow(postId, reportData);
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                tbody.innerHTML = '';
                if (error.code === 'permission-denied') {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-cell">Admin access required to view reports</td></tr>';
                } else if (error.message?.includes('index')) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-cell">Database indexes are being created. Please try again in a few minutes.</td></tr>';
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-cell">Unable to load reports</td></tr>';
                }
            }
        }

        function createReportRow(postId, reportData) {
            const row = document.createElement('tr');
            const firstReported = reportData.firstReported ?
                new Date(reportData.firstReported.toDate()).toLocaleString() : 'N/A';
            const reasons = Array.from(reportData.reasons).join(', ') || 'No reason specified';
            const status = reportData.count >= 5 ? 'Critical' : reportData.status === 'resolved' ? 'Resolved' : 'Pending';
            const statusClass = status === 'Critical' ? 'badge-danger' :
                               status === 'Resolved' ? 'badge-success' : 'badge-warning';

            row.innerHTML = `
                <td><input type="checkbox" class="report-checkbox" data-post-id="${postId}" data-report-ids="${reportData.reportIds.join(',')}"></td>
                <td>${postId.substring(0, 8)}...</td>
                <td>${reportData.postTitle}</td>
                <td><span class="badge badge-danger">${reportData.count}</span></td>
                <td>${reasons}</td>
                <td>${firstReported}</td>
                <td><span class="badge ${statusClass}">${status}</span></td>
                <td>
                    <button class="action-btn btn-view" onclick="viewReport('${postId}')">Review</button>
                    ${reportData.count >= 5 && status !== 'Resolved' ?
                        `<button class="action-btn btn-delete" onclick="autoRemove('${postId}')">Auto-Remove</button>` : ''
                    }
                    ${status !== 'Resolved' ?
                        `<button class="action-btn btn-restore" onclick="resolveReports('${postId}', '${reportData.reportIds.join(',')}')">Resolve</button>` : ''
                    }
                </td>
            `;
            return row;
        }

        // Load analytics
        async function loadAnalytics() {
            try {
                // Get total posts
                const postsSnapshot = await getCountFromServer(collection(db, 'posts'));
                document.getElementById('totalPosts').textContent = postsSnapshot.data().count.toLocaleString();

                // Get active users (posted in last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const activeUsersQuery = query(
                    collection(db, 'posts'),
                    where('createdAt', '>=', Timestamp.fromDate(thirtyDaysAgo))
                );
                const activeUsersSnapshot = await getDocs(activeUsersQuery);
                const uniqueUsers = new Set(activeUsersSnapshot.docs.map(doc => doc.data().userId));
                document.getElementById('activeUsers').textContent = uniqueUsers.size.toLocaleString();

                // Calculate engagement rate
                const allPostsSnapshot = await getDocs(collection(db, 'posts'));
                let totalLikes = 0;
                let totalComments = 0;
                allPostsSnapshot.forEach(doc => {
                    const post = doc.data();
                    totalLikes += post.likes?.length || 0;
                    totalComments += post.comments?.length || 0;
                });
                const engagementRate = allPostsSnapshot.size > 0 ?
                    Math.round(((totalLikes + totalComments) / allPostsSnapshot.size) * 100) : 0;
                document.getElementById('engagementRate').textContent = engagementRate + '%';

                // Update charts with real data
                await updateChartsWithRealData();
            } catch (error) {
                console.error('Error loading analytics:', error);
                showMessage('Error loading analytics', 'error');
            }
        }

        async function updateChartsWithRealData() {
            // Get data for last 7 days
            const days = [];
            const userCounts = [];
            const postCounts = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);

                const nextDate = new Date(date);
                nextDate.setDate(nextDate.getDate() + 1);

                days.push(['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()]);

                // Count posts for this day
                const postsQuery = query(
                    collection(db, 'posts'),
                    where('createdAt', '>=', Timestamp.fromDate(date)),
                    where('createdAt', '<', Timestamp.fromDate(nextDate))
                );
                const postsSnapshot = await getCountFromServer(postsQuery);
                postCounts.push(postsSnapshot.data().count);

                // Count active users for this day
                const usersQuery = query(
                    collection(db, 'users'),
                    where('lastActive', '>=', Timestamp.fromDate(date)),
                    where('lastActive', '<', Timestamp.fromDate(nextDate))
                );
                const usersSnapshot = await getCountFromServer(usersQuery);
                userCounts.push(usersSnapshot.data().count);
            }

            // Update activity chart
            if (charts.activity) {
                charts.activity.data.labels = days;
                charts.activity.data.datasets[0].data = userCounts;
                charts.activity.update();
            }

            // Get category distribution
            const categories = {};
            const postsSnapshot = await getDocs(collection(db, 'posts'));
            postsSnapshot.forEach(doc => {
                const category = doc.data().category || 'General';
                categories[category] = (categories[category] || 0) + 1;
            });

            // Update category chart
            if (charts.category) {
                charts.category.data.labels = Object.keys(categories);
                charts.category.data.datasets[0].data = Object.values(categories);
                charts.category.update();
            }

            // Get user growth data
            const growthData = [];
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                date.setDate(1);
                date.setHours(0, 0, 0, 0);

                const usersQuery = query(
                    collection(db, 'users'),
                    where('createdAt', '<=', Timestamp.fromDate(date))
                );
                const usersSnapshot = await getCountFromServer(usersQuery);
                growthData.push(usersSnapshot.data().count);
            }

            // Update growth chart
            if (charts.growth) {
                charts.growth.data.datasets[0].data = growthData;
                charts.growth.update();
            }
        }

        // Filter functions
        function filterTableRows(tableBodyId, searchTerm) {
            const tbody = document.getElementById(tableBodyId);
            const rows = tbody.getElementsByTagName('tr');
            const term = searchTerm.toLowerCase();

            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            }
        }

        function filterUserCards(searchTerm) {
            const cards = document.querySelectorAll('.user-card');
            const term = searchTerm.toLowerCase();

            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(term) ? '' : 'none';
            });
        }

        // Pagination
        function updatePaginationControls(section, hasMore) {
            const paginationId = `${section}Pagination`;
            let paginationEl = document.getElementById(paginationId);

            if (!paginationEl) {
                // Create pagination controls if they don't exist
                const container = section === 'users' ?
                    document.getElementById('usersList').parentElement :
                    document.querySelector(`#${section} .table-container`).parentElement;

                paginationEl = document.createElement('div');
                paginationEl.id = paginationId;
                paginationEl.className = 'pagination';
                container.appendChild(paginationEl);
            }

            paginationEl.innerHTML = `
                <button onclick="previousPage('${section}')" ${currentPage[section] <= 1 ? 'disabled' : ''}>
                    Previous
                </button>
                <span>Page ${currentPage[section]}</span>
                <button onclick="nextPage('${section}')" ${!hasMore ? 'disabled' : ''}>
                    Next
                </button>
            `;
        }

        window.previousPage = async (section) => {
            if (currentPage[section] > 1) {
                currentPage[section]--;
                lastVisible[section] = null;
                if (section === 'posts') await loadPosts(currentPage[section]);
                else if (section === 'users') await loadUsers(currentPage[section]);
            }
        };

        window.nextPage = async (section) => {
            currentPage[section]++;
            if (section === 'posts') await loadPosts(currentPage[section]);
            else if (section === 'users') await loadUsers(currentPage[section]);
        };

        // Setup real-time listeners
        function setupRealtimeListeners() {
            // Listen to new posts
            onSnapshot(
                query(collection(db, 'posts'), orderBy('createdAt', 'desc'), limit(1)),
                (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added' && !window.initialLoad) {
                            showMessage('New post added', 'info');
                            loadPosts();
                            loadStats();
                        }
                    });
                    window.initialLoad = false;
                }
            );

            // Listen to new reports
            onSnapshot(
                query(collection(db, 'reports'), orderBy('createdAt', 'desc'), limit(1)),
                (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added' && !window.initialReportLoad) {
                            showMessage('New report received', 'warning');
                            loadReports();
                            loadStats();
                        }
                    });
                    window.initialReportLoad = false;
                }
            );

            // Listen to user changes
            onSnapshot(
                query(collection(db, 'users'), orderBy('createdAt', 'desc'), limit(1)),
                (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added' && !window.initialUserLoad) {
                            showMessage('New user registered', 'success');
                            loadUsers();
                            loadStats();
                        }
                    });
                    window.initialUserLoad = false;
                }
            );
        }

        // Initialize charts
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            };

            // User Activity Chart
            const activityCtx = document.getElementById('activityChart');
            if (activityCtx) {
                charts.activity = new Chart(activityCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Active Users',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#6C4DF4',
                            backgroundColor: 'rgba(108, 77, 244, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: chartOptions
                });
            }

            // Category Chart
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx) {
                charts.category = new Chart(categoryCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Loading...'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#e0e0e0']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            // Growth Chart
            const growthCtx = document.getElementById('growthChart');
            if (growthCtx) {
                charts.growth = new Chart(growthCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['6 months ago', '5 months ago', '4 months ago', '3 months ago', '2 months ago', 'Last month'],
                        datasets: [{
                            label: 'Total Users',
                            data: [0, 0, 0, 0, 0, 0],
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: chartOptions
                });
            }

            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                charts.revenue = new Chart(revenueCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Revenue (R)',
                            data: [0, 0, 0, 0, 0, 0],
                            backgroundColor: '#6C4DF4'
                        }]
                    },
                    options: chartOptions
                });
            }
        }

        // Post operations
        window.viewPost = async (postId) => {
            try {
                const postDoc = await getDoc(doc(db, 'posts', postId));
                if (postDoc.exists()) {
                    const post = postDoc.data();
                    showModal('Post Details', `
                        <div class="detail-group">
                            <strong>Post ID:</strong> ${postId}
                        </div>
                        <div class="detail-group">
                            <strong>Author:</strong> ${post.userName || 'Unknown'}
                        </div>
                        <div class="detail-group">
                            <strong>Category:</strong> ${post.category || 'General'}
                        </div>
                        <div class="detail-group">
                            <strong>Created:</strong> ${post.createdAt ? new Date(post.createdAt.toDate()).toLocaleString() : 'N/A'}
                        </div>
                        <div class="detail-group">
                            <strong>Status:</strong> ${post.status || 'Active'}
                        </div>
                        <div class="detail-group">
                            <strong>Content:</strong>
                            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                ${post.content || 'No content'}
                            </div>
                        </div>
                        <div class="detail-group">
                            <strong>Likes:</strong> ${post.likes?.length || 0}
                        </div>
                        <div class="detail-group">
                            <strong>Comments:</strong> ${post.comments?.length || 0}
                        </div>
                    `);
                }
            } catch (error) {
                console.error('Error viewing post:', error);
                showMessage('Error loading post details', 'error');
            }
        };

        window.removePost = async (postId) => {
            if (confirm('Are you sure you want to remove this post?')) {
                try {
                    await updateDoc(doc(db, 'posts', postId), {
                        status: 'Removed',
                        removedAt: Timestamp.now(),
                        removedBy: currentUser.uid
                    });
                    showMessage('Post removed successfully', 'success');
                    await loadPosts();
                } catch (error) {
                    console.error('Error removing post:', error);
                    showMessage('Error removing post', 'error');
                }
            }
        };

        window.restorePost = async (postId) => {
            try {
                await updateDoc(doc(db, 'posts', postId), {
                    status: 'Active',
                    restoredAt: Timestamp.now(),
                    restoredBy: currentUser.uid
                });
                showMessage('Post restored successfully', 'success');
                await loadPosts();
            } catch (error) {
                console.error('Error restoring post:', error);
                showMessage('Error restoring post', 'error');
            }
        };

        window.autoRemove = async (postId) => {
            if (confirm('This post has 5+ reports. Remove it automatically?')) {
                try {
                    await updateDoc(doc(db, 'posts', postId), {
                        status: 'Auto-Removed',
                        removedAt: Timestamp.now(),
                        removedReason: 'Multiple reports (5+)',
                        removedBy: currentUser.uid
                    });
                    showMessage('Post auto-removed successfully', 'success');
                    await loadPosts();
                    await loadReports();
                } catch (error) {
                    console.error('Error removing post:', error);
                    showMessage('Error removing post', 'error');
                }
            }
        };

        // User operations
        window.viewUser = async (userId) => {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const user = userDoc.data();
                    showModal('User Details', `
                        <div class="detail-group">
                            <strong>User ID:</strong> ${userId}
                        </div>
                        <div class="detail-group">
                            <strong>Name:</strong> ${user.name || 'Not provided'}
                        </div>
                        <div class="detail-group">
                            <strong>Email:</strong> ${user.email || 'Not provided'}
                        </div>
                        <div class="detail-group">
                            <strong>Phone:</strong> ${user.phone || 'Not provided'}
                        </div>
                        <div class="detail-group">
                            <strong>Plan:</strong> ${user.subscriptionPlan || 'Basic'}
                        </div>
                        <div class="detail-group">
                            <strong>Status:</strong> ${user.status || 'Active'}
                        </div>
                        <div class="detail-group">
                            <strong>Role:</strong> ${user.role || 'User'}
                        </div>
                        <div class="detail-group">
                            <strong>Joined:</strong> ${user.createdAt ? new Date(user.createdAt.toDate()).toLocaleString() : 'N/A'}
                        </div>
                        <div class="detail-group">
                            <strong>Last Active:</strong> ${user.lastActive ? new Date(user.lastActive.toDate()).toLocaleString() : 'Never'}
                        </div>
                    `);
                }
            } catch (error) {
                console.error('Error viewing user:', error);
                showMessage('Error loading user details', 'error');
            }
        };

        window.suspendUser = async (userId) => {
            if (confirm('Are you sure you want to suspend this user?')) {
                try {
                    await updateDoc(doc(db, 'users', userId), {
                        status: 'suspended',
                        suspendedAt: Timestamp.now(),
                        suspendedBy: currentUser.uid
                    });
                    showMessage('User suspended successfully', 'success');
                    await loadUsers();
                } catch (error) {
                    console.error('Error suspending user:', error);
                    showMessage('Error suspending user', 'error');
                }
            }
        };

        window.activateUser = async (userId) => {
            try {
                await updateDoc(doc(db, 'users', userId), {
                    status: 'active',
                    activatedAt: Timestamp.now(),
                    activatedBy: currentUser.uid
                });
                showMessage('User activated successfully', 'success');
                await loadUsers();
            } catch (error) {
                console.error('Error activating user:', error);
                showMessage('Error activating user', 'error');
            }
        };

        // Report operations
        window.viewReport = async (postId) => {
            try {
                const reportsQuery = query(
                    collection(db, 'reports'),
                    where('postId', '==', postId)
                );
                const snapshot = await getDocs(reportsQuery);

                let reportDetails = '<div class="reports-list">';
                snapshot.forEach(doc => {
                    const report = doc.data();
                    reportDetails += `
                        <div class="report-item">
                            <strong>Reporter:</strong> ${report.reporterName || 'Anonymous'}<br>
                            <strong>Reason:</strong> ${report.reason || 'Not specified'}<br>
                            <strong>Date:</strong> ${report.createdAt ? new Date(report.createdAt.toDate()).toLocaleString() : 'N/A'}<br>
                            <strong>Details:</strong> ${report.details || 'No additional details'}
                        </div>
                    `;
                });
                reportDetails += '</div>';

                showModal(`Reports for Post ${postId.substring(0, 8)}...`, reportDetails);
            } catch (error) {
                console.error('Error viewing reports:', error);
                showMessage('Error loading report details', 'error');
            }
        };

        window.resolveReports = async (postId, reportIds) => {
            if (confirm('Mark these reports as resolved?')) {
                try {
                    const batch = writeBatch(db);
                    const ids = reportIds.split(',');

                    for (const reportId of ids) {
                        batch.update(doc(db, 'reports', reportId), {
                            status: 'resolved',
                            resolvedAt: Timestamp.now(),
                            resolvedBy: currentUser.uid
                        });
                    }

                    await batch.commit();
                    showMessage('Reports resolved successfully', 'success');
                    await loadReports();
                } catch (error) {
                    console.error('Error resolving reports:', error);
                    showMessage('Error resolving reports', 'error');
                }
            }
        };

        // Batch operations
        window.batchDeletePosts = async () => {
            const checkboxes = document.querySelectorAll('#postsTableBody .row-checkbox:checked');
            if (checkboxes.length === 0) {
                showMessage('No posts selected', 'warning');
                return;
            }

            if (confirm(`Remove ${checkboxes.length} selected posts?`)) {
                try {
                    const batch = writeBatch(db);
                    checkboxes.forEach(checkbox => {
                        const postId = checkbox.dataset.id;
                        batch.update(doc(db, 'posts', postId), {
                            status: 'Removed',
                            removedAt: Timestamp.now(),
                            removedBy: currentUser.uid
                        });
                    });
                    await batch.commit();
                    showMessage(`${checkboxes.length} posts removed`, 'success');
                    await loadPosts();
                } catch (error) {
                    console.error('Error in batch delete:', error);
                    showMessage('Error removing posts', 'error');
                }
            }
        };

        window.batchSuspendUsers = async () => {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            if (checkboxes.length === 0) {
                showMessage('No users selected', 'warning');
                return;
            }

            if (confirm(`Suspend ${checkboxes.length} selected users?`)) {
                try {
                    const batch = writeBatch(db);
                    checkboxes.forEach(checkbox => {
                        const userId = checkbox.dataset.id;
                        batch.update(doc(db, 'users', userId), {
                            status: 'suspended',
                            suspendedAt: Timestamp.now(),
                            suspendedBy: currentUser.uid
                        });
                    });
                    await batch.commit();
                    showMessage(`${checkboxes.length} users suspended`, 'success');
                    await loadUsers();
                } catch (error) {
                    console.error('Error in batch suspend:', error);
                    showMessage('Error suspending users', 'error');
                }
            }
        };

        // Export functions
        window.exportData = async (type) => {
            try {
                showLoading('Preparing export...');
                let data = [];
                let filename = '';

                if (type === 'posts') {
                    const snapshot = await getDocs(collection(db, 'posts'));
                    snapshot.forEach(doc => {
                        const post = doc.data();
                        data.push({
                            id: doc.id,
                            title: post.title || '',
                            content: post.content || '',
                            author: post.userName || '',
                            category: post.category || '',
                            status: post.status || 'Active',
                            createdAt: post.createdAt ? new Date(post.createdAt.toDate()).toISOString() : '',
                            likes: post.likes?.length || 0,
                            comments: post.comments?.length || 0
                        });
                    });
                    filename = `posts-export-${new Date().toISOString().split('T')[0]}.csv`;
                } else if (type === 'users') {
                    const snapshot = await getDocs(collection(db, 'users'));
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        data.push({
                            id: doc.id,
                            name: user.name || '',
                            email: user.email || '',
                            phone: user.phone || '',
                            plan: user.subscriptionPlan || 'basic',
                            status: user.status || 'active',
                            role: user.role || 'user',
                            joinedAt: user.createdAt ? new Date(user.createdAt.toDate()).toISOString() : ''
                        });
                    });
                    filename = `users-export-${new Date().toISOString().split('T')[0]}.csv`;
                } else if (type === 'reports') {
                    const snapshot = await getDocs(collection(db, 'reports'));
                    snapshot.forEach(doc => {
                        const report = doc.data();
                        data.push({
                            id: doc.id,
                            postId: report.postId || '',
                            postTitle: report.postTitle || '',
                            reason: report.reason || '',
                            details: report.details || '',
                            reporterName: report.reporterName || '',
                            status: report.status || 'pending',
                            createdAt: report.createdAt ? new Date(report.createdAt.toDate()).toISOString() : ''
                        });
                    });
                    filename = `reports-export-${new Date().toISOString().split('T')[0]}.csv`;
                }

                // Convert to CSV
                if (data.length > 0) {
                    const csv = convertToCSV(data);
                    downloadCSV(csv, filename);
                    hideLoading();
                    showMessage('Export completed', 'success');
                } else {
                    hideLoading();
                    showMessage('No data to export', 'warning');
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                hideLoading();
                showMessage('Error exporting data', 'error');
            }
        };

        function convertToCSV(data) {
            if (data.length === 0) return '';

            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');

            const csvRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' && value.includes(',') ?
                        `"${value}"` : value;
                }).join(',');
            });

            return [csvHeaders, ...csvRows].join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Settings
        window.saveSettings = async () => {
            const settings = {
                autoRemove5: document.getElementById('autoRemove5').checked,
                flagInappropriate: document.getElementById('flagInappropriate').checked,
                requireApproval: document.getElementById('requireApproval').checked,
                updatedAt: Timestamp.now(),
                updatedBy: currentUser.uid
            };

            try {
                await setDoc(doc(db, 'settings', 'moderation'), settings, { merge: true });
                showMessage('Settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving settings:', error);
                showMessage('Error saving settings', 'error');
            }
        };

        window.addAdmin = async () => {
            const email = document.getElementById('adminEmail').value;
            if (!email) {
                showMessage('Please enter an email address', 'warning');
                return;
            }

            try {
                // Find user by email
                const usersQuery = query(collection(db, 'users'), where('email', '==', email));
                const snapshot = await getDocs(usersQuery);

                if (snapshot.empty) {
                    showMessage('User not found', 'error');
                    return;
                }

                const userDoc = snapshot.docs[0];
                await updateDoc(doc(db, 'users', userDoc.id), {
                    role: 'admin',
                    isAdmin: true,
                    adminGrantedAt: Timestamp.now(),
                    adminGrantedBy: currentUser.uid
                });

                showMessage(`Admin access granted to ${email}`, 'success');
                document.getElementById('adminEmail').value = '';
            } catch (error) {
                console.error('Error adding admin:', error);
                showMessage('Error granting admin access', 'error');
            }
        };

        // Filter handlers
        window.applyPostFilters = async () => {
            currentFilters.posts.search = document.getElementById('postSearch').value;
            currentFilters.posts.category = document.getElementById('categoryFilter').value;
            const dateRange = document.getElementById('dateFilter').value;
            currentFilters.posts.dateRange = dateRange === 'all' ? null : parseInt(dateRange);

            currentPage.posts = 1;
            lastVisible.posts = null;
            await loadPosts();
        };

        window.applyUserFilters = async () => {
            currentFilters.users.search = document.getElementById('userSearch').value;
            currentFilters.users.plan = document.getElementById('planFilter').value;

            currentPage.users = 1;
            lastVisible.users = null;
            await loadUsers();
        };

        // Modal functions
        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>${title}</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Initialize
        window.initialLoad = true;
        window.initialReportLoad = true;
        window.initialUserLoad = true;

        // Expose functions globally
        window.logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        window.showSection = (sectionName) => {
            // Update menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.menu-item').classList.add('active');

            // Update content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName).classList.add('active');

            // Load section-specific data if needed
            if (sectionName === 'analytics') {
                loadAnalytics();
            }
        };

        window.refreshDashboard = async () => {
            await loadDashboardData();
            showMessage('Dashboard refreshed', 'success');
        };
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Loading overlay */
        .global-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6C4DF4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loader-text {
            margin-top: 20px;
            color: #6C4DF4;
            font-size: 18px;
        }

        /* Messages */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: block;
        }

        .login-title {
            color: #6C4DF4;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #6C4DF4;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #6C4DF4, #9C27B0);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(108, 77, 244, 0.3);
        }

        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            background: #f5f5f5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            width: 40px;
            height: 40px;
        }

        .header-title {
            color: #6C4DF4;
            font-size: 24px;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .current-user {
            color: #666;
            font-size: 14px;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .refresh-btn {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .refresh-btn:hover {
            background: #229954;
        }

        /* Sidebar */
        .dashboard-content {
            display: flex;
        }

        .sidebar {
            width: 250px;
            background: white;
            min-height: calc(100vh - 70px);
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 15px 30px;
            cursor: pointer;
            transition: background 0.3s;
            color: #666;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover {
            background: #f8f9fa;
        }

        .menu-item.active {
            background: linear-gradient(90deg, rgba(108,77,244,0.1) 0%, transparent 100%);
            color: #6C4DF4;
            border-left: 3px solid #6C4DF4;
        }

        .menu-icon {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-x: auto;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .export-btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .export-btn:hover {
            background: #2980b9;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .stat-label {
            color: #999;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 14px;
            color: #27ae60;
        }

        .stat-change.negative {
            color: #e74c3c;
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Filter Bar */
        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
        }

        .filter-select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            min-width: 150px;
        }

        .filter-btn {
            padding: 10px 20px;
            background: #6C4DF4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .filter-btn:hover {
            background: #5a3fd8;
        }

        .batch-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            margin-left: auto;
        }

        .batch-btn:hover {
            background: #c0392b;
        }

        /* Tables */
        .posts-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #6C4DF4;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .row-checkbox,
        .user-checkbox,
        .report-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .loading-cell,
        .empty-cell {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
            transition: opacity 0.3s;
        }

        .action-btn:hover {
            opacity: 0.8;
        }

        .btn-view {
            background: #3498db;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-restore {
            background: #27ae60;
            color: white;
        }

        /* Users */
        .user-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6C4DF4, #9C27B0);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
        }

        .user-details h3 {
            margin-bottom: 5px;
            color: #333;
        }

        .user-details p {
            color: #999;
            font-size: 14px;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #333;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 20px;
        }

        .detail-group {
            margin-bottom: 15px;
        }

        .detail-group strong {
            color: #666;
        }

        .report-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        .pagination button {
            padding: 10px 20px;
            background: #6C4DF4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #5a3fd8;
        }

        .pagination button:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6C4DF4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .main-content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-input, .filter-select {
                width: 100%;
            }

            .user-card {
                flex-direction: column;
                gap: 15px;
            }

            .user-info {
                width: 100%;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Global Loader -->
    <div class="global-loader" id="globalLoader" style="display: none;">
        <div class="loader-spinner"></div>
        <div class="loader-text">Loading...</div>
    </div>

    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <img src="logo.png" alt="LocalLoop" class="logo">
            <h2 class="login-title">Admin Dashboard - Complete</h2>
            <form id="loginForm">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="admin@localloop.co.za" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="login-btn">Login with Firebase</button>
                <div class="error-message" id="errorMessage"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <img src="logo.png" alt="LocalLoop" class="header-logo">
                <h1 class="header-title">LocalLoop Admin</h1>
            </div>
            <div class="header-right">
                <span class="current-user">Logged in as: <span id="currentUserEmail"></span></span>
                <button class="refresh-btn" onclick="refreshDashboard()">🔄 Refresh</button>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="dashboard-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <nav class="sidebar-menu">
                    <div class="menu-item active" onclick="showSection('overview')">
                        <span class="menu-icon">📊</span>
                        <span>Overview</span>
                    </div>
                    <div class="menu-item" onclick="showSection('posts')">
                        <span class="menu-icon">📝</span>
                        <span>Posts Management</span>
                    </div>
                    <div class="menu-item" onclick="showSection('users')">
                        <span class="menu-icon">👥</span>
                        <span>Users</span>
                    </div>
                    <div class="menu-item" onclick="showSection('reports')">
                        <span class="menu-icon">⚠️</span>
                        <span>Reports</span>
                    </div>
                    <div class="menu-item" onclick="showSection('analytics')">
                        <span class="menu-icon">📈</span>
                        <span>Analytics</span>
                    </div>
                    <div class="menu-item" onclick="showSection('settings')">
                        <span class="menu-icon">⚙️</span>
                        <span>Settings</span>
                    </div>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Overview Section -->
                <section class="content-section active" id="overview">
                    <div class="section-header">
                        <h2>Dashboard Overview</h2>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Users</div>
                            <div class="stat-value" id="totalUsers">
                                <div class="loading"></div>
                            </div>
                            <div class="stat-change">Live from database</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Posts (7 days)</div>
                            <div class="stat-value" id="activePosts">
                                <div class="loading"></div>
                            </div>
                            <div class="stat-change">Recent activity</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Reports Today</div>
                            <div class="stat-value" id="reportsToday">
                                <div class="loading"></div>
                            </div>
                            <div class="stat-change negative">Needs attention</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Monthly Revenue</div>
                            <div class="stat-value" id="monthlyRevenue">
                                <div class="loading"></div>
                            </div>
                            <div class="stat-change">From subscriptions</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">User Activity - Last 7 Days</h3>
                        <div class="chart-wrapper">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Posts by Category</h3>
                        <div class="chart-wrapper">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Posts Management Section -->
                <section class="content-section" id="posts">
                    <div class="section-header">
                        <h2>Posts Management</h2>
                        <button class="export-btn" onclick="exportData('posts')">📥 Export</button>
                    </div>

                    <div class="filter-bar">
                        <input type="text" class="filter-input" placeholder="Search posts..." id="postSearch">
                        <select class="filter-select" id="categoryFilter">
                            <option value="all">All Categories</option>
                            <option value="Restaurant">Restaurant</option>
                            <option value="Retail">Retail</option>
                            <option value="Services">Services</option>
                            <option value="Events">Events</option>
                            <option value="General">General</option>
                        </select>
                        <select class="filter-select" id="dateFilter">
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 3 Months</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="filter-btn" onclick="applyPostFilters()">Apply Filters</button>
                        <button class="batch-btn" onclick="batchDeletePosts()">Delete Selected</button>
                    </div>

                    <div class="posts-table">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" onclick="
                                                document.querySelectorAll('#postsTableBody .row-checkbox').forEach(cb => cb.checked = this.checked)
                                            ">
                                        </th>
                                        <th>ID</th>
                                        <th>Title/Content</th>
                                        <th>Author</th>
                                        <th>Category</th>
                                        <th>Date</th>
                                        <th>Reports</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="postsTableBody">
                                    <tr>
                                        <td colspan="9" class="loading-cell">Loading posts...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Users Section -->
                <section class="content-section" id="users">
                    <div class="section-header">
                        <h2>User Management</h2>
                        <button class="export-btn" onclick="exportData('users')">📥 Export</button>
                    </div>

                    <div class="filter-bar">
                        <input type="text" class="filter-input" placeholder="Search users..." id="userSearch">
                        <select class="filter-select" id="planFilter">
                            <option value="all">All Plans</option>
                            <option value="basic">Basic</option>
                            <option value="premium">Premium</option>
                            <option value="gold">Gold</option>
                        </select>
                        <button class="filter-btn" onclick="applyUserFilters()">Search</button>
                        <button class="batch-btn" onclick="batchSuspendUsers()">Suspend Selected</button>
                    </div>

                    <div id="usersList">
                        <div class="loading-cell">Loading users...</div>
                    </div>
                </section>

                <!-- Reports Section -->
                <section class="content-section" id="reports">
                    <div class="section-header">
                        <h2>Reported Content</h2>
                        <button class="export-btn" onclick="exportData('reports')">📥 Export</button>
                    </div>

                    <div class="posts-table">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" onclick="
                                                document.querySelectorAll('.report-checkbox').forEach(cb => cb.checked = this.checked)
                                            ">
                                        </th>
                                        <th>Post ID</th>
                                        <th>Post Title</th>
                                        <th>Reports Count</th>
                                        <th>Report Reasons</th>
                                        <th>First Reported</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsTableBody">
                                    <tr>
                                        <td colspan="8" class="loading-cell">Loading reports...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Analytics Section -->
                <section class="content-section" id="analytics">
                    <h2 style="margin-bottom: 30px;">Advanced Analytics</h2>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Posts</div>
                            <div class="stat-value" id="totalPosts">0</div>
                            <div class="stat-change">All-time</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Users (30 days)</div>
                            <div class="stat-value" id="activeUsers">0</div>
                            <div class="stat-change">Posted recently</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Engagement Rate</div>
                            <div class="stat-value" id="engagementRate">0%</div>
                            <div class="stat-change">Likes & comments</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Revenue Trends</h3>
                        <div class="chart-wrapper">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">User Growth</h3>
                        <div class="chart-wrapper">
                            <canvas id="growthChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Settings Section -->
                <section class="content-section" id="settings">
                    <h2 style="margin-bottom: 30px;">Settings</h2>

                    <div class="stat-card">
                        <h3 style="margin-bottom: 20px;">Auto-Moderation Rules</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="autoRemove5" checked>
                                <span>Auto-remove posts with 5+ reports</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="flagInappropriate" checked>
                                <span>Flag posts with inappropriate content</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="requireApproval">
                                <span>Require approval for new user posts</span>
                            </label>
                        </div>
                        <button class="filter-btn" onclick="saveSettings()">Save Settings</button>
                    </div>

                    <div class="stat-card" style="margin-top: 20px;">
                        <h3 style="margin-bottom: 20px;">Admin Users</h3>
                        <p style="margin-bottom: 15px;">Add admin privileges to users by their email:</p>
                        <input type="email" class="filter-input" placeholder="user@example.com" id="adminEmail" style="margin-bottom: 15px;">
                        <button class="filter-btn" onclick="addAdmin()">Grant Admin Access</button>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
                // Auth state change will handle the rest
            } catch (error) {
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorMessage').style.display = 'block';
            }
        });
    </script>
</body>
</html>